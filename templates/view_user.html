{% extends "base.html" %}

{% block title %}Detalhes de {{ get_attr_value(user, 'displayName') or 'Usuário' }}{% endblock %}

{% from "_macros.html" import render_page_header %}

{% block page_title %}
    {% set title_text = '<i class="fas fa-user-circle me-2"></i>Detalhes de: ' ~ (get_attr_value(user, 'displayName') or 'N/A') %}
    {{ render_page_header(title_text) }}
{% endblock %}


{% block content %}
<div class="row">
    <div class="col-lg-4 mb-4">
        <div class="card glass-card">
            <div class="card-header">
                <h5 class="mb-0">Status da Conta</h5>
            </div>
            <div class="card-body">
                {% set status = get_user_status(user) %}
                <p><strong>Status:</strong> <span class="badge rounded-pill bg-{{ 'success' if status == 'Ativo' else 'danger' }} fs-6">{{ status }}</span></p>
                <p class="mt-3"><strong>Expiração da Senha:</strong><br><span class="text-highlight">{{ password_expiry_info }}</span></p>
            </div>
        </div>

        <div class="card glass-card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Ações Rápidas</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if check_permission(action='can_disable') %}
                        {% if status == 'Desativado' %}
                            <form action="{{ url_for('toggle_status', username=get_attr_value(user, 'sAMAccountName')) }}" method="POST">
                                {{ form.csrf_token }}
                                <button type="submit" class="btn btn-success w-100"><i class="fas fa-check-circle me-2"></i>Reativar Conta</button>
                            </form>
                        {% elif status == 'Ativo' %}
                            <button type="button" class="btn btn-info w-100" data-bs-toggle="modal" data-bs-target="#scheduleAbsenceModal">
                                <i class="fas fa-calendar-alt me-2"></i>Agendar Ausência
                            </button>
                            <form action="{{ url_for('toggle_status', username=get_attr_value(user, 'sAMAccountName')) }}" method="POST" onsubmit="return confirm('Tem certeza que deseja desativar esta conta permanentemente?');">
                                {{ form.csrf_token }}
                                <button type="submit" class="btn btn-danger w-100"><i class="fas fa-ban me-2"></i>Desativar Permanente</button>
                            </form>
                        {% endif %}
                    {% endif %}

                    {% if check_permission(action='can_reset_password') %}
                    <form action="{{ url_for('reset_password', username=get_attr_value(user, 'sAMAccountName')) }}" method="POST" onsubmit="return confirm('Tem certeza que deseja resetar a senha deste usuário para a padrão?');">
                        {{ form.csrf_token }}
                        <button type="submit" class="btn btn-secondary w-100"><i class="fas fa-key me-2"></i>Resetar Senha</button>
                    </form>
                    {% endif %}

                    {% if check_permission(action='can_edit') %}
                        <a href="{{ url_for('edit_user', username=get_attr_value(user, 'sAMAccountName')) }}" class="btn btn-primary w-100"><i class="fas fa-edit me-2"></i>Editar Usuário</a>
                    {% endif %}
                </div>
            </div>
        </div>

        {% if check_permission(action='can_delete_user') %}
        <div class="card border-danger mt-4">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Zona de Perigo</h5>
            </div>
            <div class="card-body text-center">
                <p>A exclusão de um usuário é uma ação irreversível e removerá permanentemente o objeto do Active Directory.</p>
                <button type="button" class="btn btn-danger w-100" data-bs-toggle="modal" data-bs-target="#deleteUserModal">
                    <i class="fas fa-trash-alt me-2"></i>Excluir Usuário
                </button>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="col-lg-8">
        <div class="card glass-card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="user-details-tabs" role="tablist">
                    <li class="nav-item" role="presentation"><button class="nav-link active" id="geral-tab" data-bs-toggle="tab" data-bs-target="#geral" type="button" role="tab">Geral</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" id="endereco-tab" data-bs-toggle="tab" data-bs-target="#endereco" type="button" role="tab">Endereço</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" id="telefones-tab" data-bs-toggle="tab" data-bs-target="#telefones" type="button" role="tab">Telefones</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" id="organizacao-tab" data-bs-toggle="tab" data-bs-target="#organizacao" type="button" role="tab">Organização</button></li>
                    {% if check_permission(action='can_manage_groups') %}
                    <li class="nav-item" role="presentation"><button class="nav-link" id="memberof-tab" data-bs-toggle="tab" data-bs-target="#memberof" type="button" role="tab">Membro de</button></li>
                    {% endif %}
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content p-2" id="user-details-content">
                    <div class="tab-pane fade show active" id="geral" role="tabpanel">
                        <table class="table glass-table table-borderless">
                            <tr><td style="width: 30%;"><strong>Nome:</strong></td><td>{{ get_attr_value(user, 'givenName') }}</td></tr>
                            <tr><td><strong>Iniciais:</strong></td><td>{{ get_attr_value(user, 'initials') }}</td></tr>
                            <tr><td><strong>Sobrenome:</strong></td><td>{{ get_attr_value(user, 'sn') }}</td></tr>
                            <tr><td><strong>Nome de Exibição:</strong></td><td>{{ get_attr_value(user, 'displayName') }}</td></tr>
                            <tr><td><strong>Descrição:</strong></td><td>{{ get_attr_value(user, 'description') }}</td></tr>
                            <tr><td><strong>Escritório:</strong></td><td>{{ get_attr_value(user, 'physicalDeliveryOfficeName') }}</td></tr>
                            <tr><td><strong>E-mail:</strong></td><td>{{ get_attr_value(user, 'mail') }}</td></tr>
                            <tr><td><strong>Página da Web:</strong></td><td>{{ get_attr_value(user, 'wWWHomePage') }}</td></tr>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="endereco" role="tabpanel">
                         <table class="table glass-table table-borderless">
                            <tr><td style="width: 30%;"><strong>Rua:</strong></td><td>{{ get_attr_value(user, 'streetAddress') }}</td></tr>
                            <tr><td><strong>Caixa Postal:</strong></td><td>{{ get_attr_value(user, 'postOfficeBox') }}</td></tr>
                            <tr><td><strong>Cidade:</strong></td><td>{{ get_attr_value(user, 'l') }}</td></tr>
                            <tr><td><strong>Estado/Província:</strong></td><td>{{ get_attr_value(user, 'st') }}</td></tr>
                            <tr><td><strong>CEP:</strong></td><td>{{ get_attr_value(user, 'postalCode') }}</td></tr>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="telefones" role="tabpanel">
                        <table class="table glass-table table-borderless">
                            <tr><td style="width: 30%;"><strong>Telefone Principal:</strong></td><td>{{ get_attr_value(user, 'telephoneNumber') }}</td></tr>
                            <tr><td><strong>Telefone Residencial:</strong></td><td>{{ get_attr_value(user, 'homePhone') }}</td></tr>
                            <tr><td><strong>Pager:</strong></td><td>{{ get_attr_value(user, 'pager') }}</td></tr>
                            <tr><td><strong>Celular:</strong></td><td>{{ get_attr_value(user, 'mobile') }}</td></tr>
                            <tr><td><strong>Fax:</strong></td><td>{{ get_attr_value(user, 'facsimileTelephoneNumber') }}</td></tr>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="organizacao" role="tabpanel">
                        <table class="table glass-table table-borderless">
                            <tr><td style="width: 30%;"><strong>Cargo:</strong></td><td>{{ get_attr_value(user, 'title') }}</td></tr>
                            <tr><td><strong>Departamento:</strong></td><td>{{ get_attr_value(user, 'department') }}</td></tr>
                            <tr><td><strong>Empresa:</strong></td><td>{{ get_attr_value(user, 'company') }}</td></tr>
                        </table>
                    </div>
                    {% if check_permission(action='can_manage_groups') %}
                    <div class="tab-pane fade" id="memberof" role="tabpanel" aria-labelledby="memberof-tab">
                        <div class="d-flex justify-content-end mb-2">
                            <input type="text" id="group-membership-search" class="form-control form-control-sm w-50" placeholder="Filtrar grupos...">
                        </div>
                        <div id="memberof-list-container" class="table-responsive" style="min-height: 150px;">
                            </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Agendar Ausência -->
<div class="modal fade" id="scheduleAbsenceModal" tabindex="-1" aria-labelledby="scheduleAbsenceModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="scheduleAbsenceModalLabel">Agendar Ausência para {{ get_attr_value(user, 'displayName') }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="scheduleAbsenceForm" action="{{ url_for('schedule_absence', username=get_attr_value(user, 'sAMAccountName')) }}" method="POST">
        {{ form.csrf_token }}
        <div class="modal-body">
          <div class="mb-3">
            <label for="deactivation_date" class="form-label">Data de Desativação (Início da Ausência)</label>
            <input type="date" class="form-control" id="deactivation_date" name="deactivation_date" required>
          </div>
          <div class="mb-3">
            <label for="reactivation_date" class="form-label">Data de Reativação (Fim da Ausência)</label>
            <input type="date" class="form-control" id="reactivation_date" name="reactivation_date" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar Agendamento</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>

    // NOVO SCRIPT PARA A ABA "MEMBRO DE"
    document.addEventListener('DOMContentLoaded', function() {
        const memberOfTab = document.getElementById('memberof-tab');
        const memberOfContainer = document.getElementById('memberof-list-container');
        const groupSearchInput = document.getElementById('group-membership-search');
        const username = {{ get_attr_value(user, 'sAMAccountName')|tojson }}; // Usar tojson para segurança
        let groupsData = [];
        let tabLoaded = false;

        function renderGroups(groups) {
            memberOfContainer.innerHTML = ''; // Limpa o conteúdo anterior
            if (!groups || groups.length === 0) {
                memberOfContainer.innerHTML = '<div class="alert alert-info m-2">Este usuário não é membro de nenhum grupo.</div>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'table table-sm table-hover glass-table mb-0';
            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            // Conteúdo estático é seguro com innerHTML
            headerRow.innerHTML = '<th>Nome do Grupo</th><th>Descrição</th>';
            const tbody = table.createTBody();

            groups.forEach(group => {
                const row = tbody.insertRow();

                // Célula 1: Nome do Grupo (Link) - Criado de forma segura
                const cell1 = row.insertCell();
                const link = document.createElement('a');
                link.href = `/view_group/${encodeURIComponent(group.cn)}`;
                link.textContent = group.cn; // SEGURO: textContent previne injeção de HTML
                cell1.appendChild(link);

                // Célula 2: Descrição - Criado de forma segura
                const cell2 = row.insertCell();
                cell2.textContent = group.description || 'N/A'; // SEGURO: textContent previne injeção de HTML
            });
            memberOfContainer.appendChild(table);
        }

        async function fetchUserGroups() {
            if (tabLoaded) return;

            memberOfContainer.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Carregando grupos...</p></div>';

            try {
                const response = await fetch(`/api/user_groups/${username}`);
                if (!response.ok) throw new Error('Falha ao buscar os grupos do usuário.');

                groupsData = await response.json();
                renderGroups(groupsData);
                tabLoaded = true;
            } catch (error) {
                console.error('Erro:', error);
                memberOfContainer.innerHTML = '<div class="alert alert-danger m-2">Não foi possível carregar os grupos.</div>';
            }
        }

        memberOfTab.addEventListener('shown.bs.tab', fetchUserGroups);

        groupSearchInput.addEventListener('keyup', function() {
            const query = this.value.toLowerCase();
            const filteredGroups = groupsData.filter(group => {
                return group.cn.toLowerCase().includes(query) ||
                       (group.description && group.description.toLowerCase().includes(query));
            });
            renderGroups(filteredGroups);
        });
    });
</script>
<style>
/* Custom styles for glass tabs */
.nav-tabs .nav-link {
    background-color: transparent;
    border: none;
    color: var(--text-muted-color);
    transition: color 0.2s ease-in-out, background-color 0.2s ease-in-out;
}
.nav-tabs .nav-link.active {
    background-color: rgba(255, 255, 255, 0.1);
    border-color: transparent;
    color: #fff;
}
.nav-tabs .nav-link:hover {
    color: #fff;
}
.nav-tabs {
    border-bottom: 1px solid var(--glass-border-color);
}
.tab-content .table td {
    padding-top: 0.9rem;
    padding-bottom: 0.9rem;
}
</style>

<!-- Modal de Exclusão de Usuário -->
{% if check_permission(action='can_delete_user') %}
<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteUserModalLabel"><i class="fas fa-exclamation-triangle me-2"></i>Confirmar Exclusão Permanente</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="deleteUserForm" action="{{ url_for('delete_user', username=get_attr_value(user, 'sAMAccountName')) }}" method="POST">
        {{ delete_form.hidden_tag() }}
        <div class="modal-body">
          <p>Esta ação <strong>não pode ser desfeita</strong>. O usuário <strong>{{ get_attr_value(user, 'displayName') }}</strong> será removido permanentemente.</p>
          <p>Para confirmar, por favor, digite o <strong>cargo</strong> e o <strong>login</strong> do usuário nos campos abaixo.</p>

          <div class="mb-3">
            <label for="confirm_title" class="form-label">Digite o Cargo: <strong class="text-highlight">{{ get_attr_value(user, 'title') or 'N/A' }}</strong></label>
            {{ delete_form.confirm_title(class="form-control", autocomplete="off") }}
          </div>
          <div class="mb-3">
            <label for="confirm_sam" class="form-label">Digite o Login: <strong class="text-highlight">{{ get_attr_value(user, 'sAMAccountName') }}</strong></label>
            {{ delete_form.confirm_sam(class="form-control", autocomplete="off") }}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          {{ delete_form.submit(class="btn btn-danger") }}
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

{% endblock %}