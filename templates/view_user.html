{% extends "base.html" %}

{% block title %}Detalhes de {{ get_attr_value(user, 'displayName') or 'Usuário' }}{% endblock %}

{% block page_title %}
<div class="page-header">
    <h1><i class="fas fa-user-circle me-2"></i>Detalhes de: {{ get_attr_value(user, 'displayName') or 'N/A' }}</h1>
    <div>
        <a href="{{ url_for('dashboard') }}" class="btn btn-primary"><i class="fas fa-home me-2"></i>Painel Principal</a>
        <a href="{{ url_for('manage_users') }}" class="btn btn-secondary"><i class="fas fa-arrow-left me-2"></i>Voltar para a Busca</a>
    </div>
</div>
{% endblock %}


{% block content %}
<div class="row">
    <div class="col-lg-4 mb-4">
        <div class="card glass-card">
            <div class="card-header">
                <h5 class="mb-0">Status da Conta</h5>
            </div>
            <div class="card-body">
                {% set status = get_user_status(user) %}
                <p><strong>Status:</strong> <span class="badge rounded-pill bg-{{ 'success' if status == 'Ativo' else 'danger' }} fs-6">{{ status }}</span></p>
                <p class="mt-3"><strong>Expiração da Senha:</strong><br><span class="text-highlight">{{ password_expiry_info }}</span></p>
            </div>
        </div>

        <div class="card glass-card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Ações Rápidas</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if check_permission(action='can_disable') %}
                        {% if status == 'Desativado' %}
                            <form action="{{ url_for('toggle_status', username=get_attr_value(user, 'sAMAccountName')) }}" method="POST">
                                {{ form.csrf_token }}
                                <button type="submit" class="btn btn-success w-100"><i class="fas fa-check-circle me-2"></i>Reativar Conta</button>
                            </form>
                        {% elif status == 'Ativo' %}
                            <button class="btn btn-warning w-100" onclick="prompt_disable_user()"><i class="fas fa-clock me-2"></i>Desativar por X Dias</button>
                            <form action="{{ url_for('toggle_status', username=get_attr_value(user, 'sAMAccountName')) }}" method="POST" onsubmit="return confirm('Tem certeza que deseja desativar esta conta permanentemente?');">
                                {{ form.csrf_token }}
                                <button type="submit" class="btn btn-danger w-100"><i class="fas fa-ban me-2"></i>Desativar Permanente</button>
                            </form>
                        {% endif %}
                    {% endif %}

                    {% if check_permission(action='can_reset_password') %}
                    <form action="{{ url_for('reset_password', username=get_attr_value(user, 'sAMAccountName')) }}" method="POST" onsubmit="return confirm('Tem certeza que deseja resetar a senha deste usuário para a padrão?');">
                        {{ form.csrf_token }}
                        <button type="submit" class="btn btn-secondary w-100"><i class="fas fa-key me-2"></i>Resetar Senha</button>
                    </form>
                    {% endif %}

                    {% if check_permission(action='can_edit') %}
                        <a href="{{ url_for('edit_user', username=get_attr_value(user, 'sAMAccountName')) }}" class="btn btn-primary w-100"><i class="fas fa-edit me-2"></i>Editar Usuário</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-8">
        <div class="card glass-card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="user-details-tabs" role="tablist">
                    <li class="nav-item" role="presentation"><button class="nav-link active" id="geral-tab" data-bs-toggle="tab" data-bs-target="#geral" type="button" role="tab">Geral</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" id="endereco-tab" data-bs-toggle="tab" data-bs-target="#endereco" type="button" role="tab">Endereço</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" id="telefones-tab" data-bs-toggle="tab" data-bs-target="#telefones" type="button" role="tab">Telefones</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" id="organizacao-tab" data-bs-toggle="tab" data-bs-target="#organizacao" type="button" role="tab">Organização</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" id="memberof-tab" data-bs-toggle="tab" data-bs-target="#memberof" type="button" role="tab">Membro de</button></li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content p-2" id="user-details-content">
                    <div class="tab-pane fade show active" id="geral" role="tabpanel">
                        <table class="table glass-table table-borderless">
                            <tr><td style="width: 30%;"><strong>Nome:</strong></td><td>{{ get_attr_value(user, 'givenName') }}</td></tr>
                            <tr><td><strong>Iniciais:</strong></td><td>{{ get_attr_value(user, 'initials') }}</td></tr>
                            <tr><td><strong>Sobrenome:</strong></td><td>{{ get_attr_value(user, 'sn') }}</td></tr>
                            <tr><td><strong>Nome de Exibição:</strong></td><td>{{ get_attr_value(user, 'displayName') }}</td></tr>
                            <tr><td><strong>Descrição:</strong></td><td>{{ get_attr_value(user, 'description') }}</td></tr>
                            <tr><td><strong>Escritório:</strong></td><td>{{ get_attr_value(user, 'physicalDeliveryOfficeName') }}</td></tr>
                            <tr><td><strong>E-mail:</strong></td><td>{{ get_attr_value(user, 'mail') }}</td></tr>
                            <tr><td><strong>Página da Web:</strong></td><td>{{ get_attr_value(user, 'wWWHomePage') }}</td></tr>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="endereco" role="tabpanel">
                         <table class="table glass-table table-borderless">
                            <tr><td style="width: 30%;"><strong>Rua:</strong></td><td>{{ get_attr_value(user, 'streetAddress') }}</td></tr>
                            <tr><td><strong>Caixa Postal:</strong></td><td>{{ get_attr_value(user, 'postOfficeBox') }}</td></tr>
                            <tr><td><strong>Cidade:</strong></td><td>{{ get_attr_value(user, 'l') }}</td></tr>
                            <tr><td><strong>Estado/Província:</strong></td><td>{{ get_attr_value(user, 'st') }}</td></tr>
                            <tr><td><strong>CEP:</strong></td><td>{{ get_attr_value(user, 'postalCode') }}</td></tr>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="telefones" role="tabpanel">
                        <table class="table glass-table table-borderless">
                            <tr><td style="width: 30%;"><strong>Telefone Principal:</strong></td><td>{{ get_attr_value(user, 'telephoneNumber') }}</td></tr>
                            <tr><td><strong>Telefone Residencial:</strong></td><td>{{ get_attr_value(user, 'homePhone') }}</td></tr>
                            <tr><td><strong>Pager:</strong></td><td>{{ get_attr_value(user, 'pager') }}</td></tr>
                            <tr><td><strong>Celular:</strong></td><td>{{ get_attr_value(user, 'mobile') }}</td></tr>
                            <tr><td><strong>Fax:</strong></td><td>{{ get_attr_value(user, 'facsimileTelephoneNumber') }}</td></tr>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="organizacao" role="tabpanel">
                        <table class="table glass-table table-borderless">
                            <tr><td style="width: 30%;"><strong>Cargo:</strong></td><td>{{ get_attr_value(user, 'title') }}</td></tr>
                            <tr><td><strong>Departamento:</strong></td><td>{{ get_attr_value(user, 'department') }}</td></tr>
                            <tr><td><strong>Empresa:</strong></td><td>{{ get_attr_value(user, 'company') }}</td></tr>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="memberof" role="tabpanel" aria-labelledby="memberof-tab">
                        <div class="d-flex justify-content-end mb-2">
                            <input type="text" id="group-membership-search" class="form-control form-control-sm w-50" placeholder="Filtrar grupos...">
                        </div>
                        <div id="memberof-list-container" class="table-responsive" style="min-height: 150px;">
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Função segura para desativação temporária
    function prompt_disable_user() {
        let days = prompt("Por quantos dias a conta deve ser desativada?", "30");
        if (days && !isNaN(days) && parseInt(days) > 0) {
            let form = document.createElement('form');
            form.method = 'POST';
            // A URL é gerada com segurança pelo Jinja2 no servidor
            form.action = "{{ url_for('disable_user_temp', username=get_attr_value(user, 'sAMAccountName')) }}?days=" + parseInt(days);

            let csrf_token_input = document.createElement('input');
            csrf_token_input.type = 'hidden';
            csrf_token_input.name = 'csrf_token';
            // Reutiliza um token CSRF existente na página para o novo formulário
            let existing_token = document.querySelector('form [name=csrf_token]');
            if (existing_token) {
                csrf_token_input.value = existing_token.value;
            }
            form.appendChild(csrf_token_input);

            document.body.appendChild(form);
            form.submit();
        } else if (days !== null) {
            alert("Por favor, insira um número de dias válido.");
        }
    }

    // NOVO SCRIPT PARA A ABA "MEMBRO DE"
    document.addEventListener('DOMContentLoaded', function() {
        const memberOfTab = document.getElementById('memberof-tab');
        const memberOfContainer = document.getElementById('memberof-list-container');
        const groupSearchInput = document.getElementById('group-membership-search');
        const username = {{ get_attr_value(user, 'sAMAccountName')|tojson }}; // Usar tojson para segurança
        let groupsData = [];
        let tabLoaded = false;

        function renderGroups(groups) {
            memberOfContainer.innerHTML = ''; // Limpa o conteúdo anterior
            if (!groups || groups.length === 0) {
                memberOfContainer.innerHTML = '<div class="alert alert-info m-2">Este usuário não é membro de nenhum grupo.</div>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'table table-sm table-hover glass-table mb-0';
            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            // Conteúdo estático é seguro com innerHTML
            headerRow.innerHTML = '<th>Nome do Grupo</th><th>Descrição</th>';
            const tbody = table.createTBody();

            groups.forEach(group => {
                const row = tbody.insertRow();

                // Célula 1: Nome do Grupo (Link) - Criado de forma segura
                const cell1 = row.insertCell();
                const link = document.createElement('a');
                link.href = `/view_group/${encodeURIComponent(group.cn)}`;
                link.textContent = group.cn; // SEGURO: textContent previne injeção de HTML
                cell1.appendChild(link);

                // Célula 2: Descrição - Criado de forma segura
                const cell2 = row.insertCell();
                cell2.textContent = group.description || 'N/A'; // SEGURO: textContent previne injeção de HTML
            });
            memberOfContainer.appendChild(table);
        }

        async function fetchUserGroups() {
            if (tabLoaded) return;

            memberOfContainer.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Carregando grupos...</p></div>';

            try {
                const response = await fetch(`/api/user_groups/${username}`);
                if (!response.ok) throw new Error('Falha ao buscar os grupos do usuário.');

                groupsData = await response.json();
                renderGroups(groupsData);
                tabLoaded = true;
            } catch (error) {
                console.error('Erro:', error);
                memberOfContainer.innerHTML = '<div class="alert alert-danger m-2">Não foi possível carregar os grupos.</div>';
            }
        }

        memberOfTab.addEventListener('shown.bs.tab', fetchUserGroups);

        groupSearchInput.addEventListener('keyup', function() {
            const query = this.value.toLowerCase();
            const filteredGroups = groupsData.filter(group => {
                return group.cn.toLowerCase().includes(query) ||
                       (group.description && group.description.toLowerCase().includes(query));
            });
            renderGroups(filteredGroups);
        });
    });
</script>
<style>
/* Custom styles for glass tabs */
.nav-tabs .nav-link {
    background-color: transparent;
    border: none;
    color: var(--text-muted-color);
    transition: color 0.2s ease-in-out, background-color 0.2s ease-in-out;
}
.nav-tabs .nav-link.active {
    background-color: rgba(255, 255, 255, 0.1);
    border-color: transparent;
    color: #fff;
}
.nav-tabs .nav-link:hover {
    color: #fff;
}
.nav-tabs {
    border-bottom: 1px solid var(--glass-border-color);
}
.tab-content .table td {
    padding-top: 0.9rem;
    padding-bottom: 0.9rem;
}
</style>
{% endblock %}