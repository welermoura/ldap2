{% extends "base.html" %}

{% block title %}Dashboard - Monitoramento do Ambiente{% endblock %}

{% block page_title %}
<div class="page-header">
    <h1><i class="fas fa-chart-line me-2"></i>Monitoramento do Ambiente</h1>
    <div>
        <a href="{{ url_for('address_book') }}" class="btn btn-info"><i class="fas fa-address-book me-2"></i>Catálogo de Endereços</a>
        <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary">
            <i class="fas fa-sign-out-alt me-2"></i>Sair ({{ session.get('user_display_name', 'Usuário') }})
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Linha dos Cards de Estatísticas -->
<div class="row">
    <div class="col-lg-3 col-md-6 mb-4 dashboard-stat-card" data-bs-toggle="modal" data-bs-target="#dataModal" data-category="active_users" data-title="Contas Ativas">
        <div class="card glass-card h-100">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="text-muted text-uppercase fs-7">Contas Ativas</div>
                    <div class="fs-2 fw-bold text-success">{{ active_users }}</div>
                </div>
                <div class="fs-2 text-success opacity-75"><i class="fas fa-user-check"></i></div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4 dashboard-stat-card" data-bs-toggle="modal" data-bs-target="#dataModal" data-category="disabled_users" data-title="Contas Desativadas">
        <div class="card glass-card h-100">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="text-muted text-uppercase fs-7">Contas Desativadas</div>
                    <div class="fs-2 fw-bold text-warning">{{ disabled_users }}</div>
                </div>
                <div class="fs-2 text-warning opacity-75"><i class="fas fa-user-slash"></i></div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4 dashboard-stat-card" data-bs-toggle="modal" data-bs-target="#dataModal" data-category="locked_users" data-title="Contas Bloqueadas (Última Semana)">
        <div class="card glass-card h-100">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="text-muted text-uppercase fs-7">Bloqueados na Última Semana</div>
                    <div class="fs-2 fw-bold text-danger">{{ locked_last_week }}</div>
                </div>
                <div class="fs-2 text-danger opacity-75"><i class="fas fa-user-clock"></i></div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4 dashboard-stat-card" data-bs-toggle="modal" data-bs-target="#dataModal" data-category="pending_reactivations" data-title="Reativações Pendentes (Próx. 7 dias)">
        <div class="card glass-card h-100">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="text-muted text-uppercase fs-7">Reativações (Próx. 7 dias)</div>
                    <div class="fs-2 fw-bold text-info">{{ pending_reactivations }}</div>
                </div>
                <div class="fs-2 text-info opacity-75"><i class="fas fa-calendar-check"></i></div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4 dashboard-stat-card" data-bs-toggle="modal" data-bs-target="#dataModal" data-category="pending_deactivations" data-title="Desativações Agendadas (Próx. 7 dias)">
        <div class="card glass-card h-100">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="text-muted text-uppercase fs-7">Desativações (Próx. 7 dias)</div>
                    <div class="fs-2 fw-bold text-secondary">{{ pending_deactivations }}</div>
                </div>
                <div class="fs-2 text-secondary opacity-75"><i class="fas fa-calendar-times"></i></div>
            </div>
        </div>
    </div>
</div>

<!-- Linha dos Painéis Principais -->
<div class="row">
    <!-- Painel de Senhas Expirando -->
    <div class="col-lg-8 mb-4">
        <div class="card glass-card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-key me-2 text-warning"></i>Senhas Expirando (Próximos 15 dias)</h5>
                <span id="expiring-total" class="badge bg-dark rounded-pill">Total: {{ expiring_passwords|length }}</span>
            </div>
            <div class="card-body p-0" style="min-height: 250px;">
                <div id="expiring-list-container" class="list-group list-group-flush">
                    <!-- O conteúdo será preenchido por JavaScript -->
                </div>
            </div>
            <div class="card-footer d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div class="flex-grow-1" style="min-width: 200px;">
                    <input type="text" id="expiring-search-input" class="form-control form-control-sm" placeholder="Filtrar por nome ou login...">
                </div>
                <nav id="expiring-pagination-controls" class="d-flex align-items-center gap-1">
                    <!-- Controles de paginação serão gerados por JavaScript -->
                </nav>
            </div>
        </div>
    </div>

    <!-- Painel de Ações Rápidas -->
    <div class="col-lg-4 mb-4">
        <div class="card glass-card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-rocket me-2"></i>Ações Rápidas</h5>
            </div>
            <div class="list-group list-group-flush">
                <a href="{{ url_for('create_user_form') }}" class="list-group-item list-group-item-action glass-list-item">
                    <h6 class="mb-1"><i class="fas fa-user-plus me-2 text-primary"></i>Criar Novo Usuário</h6>
                    <small class="text-muted">Crie um novo usuário no AD usando um modelo.</small>
                </a>
                <a href="{{ url_for('manage_users') }}" class="list-group-item list-group-item-action glass-list-item">
                    <h6 class="mb-1"><i class="fas fa-users-cog me-2 text-secondary"></i>Gerenciar Usuários</h6>
                    <small class="text-muted">Busque, edite e gerencie usuários existentes.</small>
                </a>
                <a href="{{ url_for('group_management') }}" class="list-group-item list-group-item-action glass-list-item">
                    <h6 class="mb-1"><i class="fas fa-layer-group me-2 text-info"></i>Gerenciar Grupos</h6>
                    <small class="text-muted">Adicione ou remova membros de grupos.</small>
                </a>
                {% if check_permission(view='can_export_data') %}
                <a href="{{ url_for('export_ad_data') }}" class="list-group-item list-group-item-action glass-list-item">
                    <h6 class="mb-1"><i class="fas fa-file-csv me-2 text-success"></i>Exportar Base AD</h6>
                    <small class="text-muted">Exporte os dados dos usuários para um arquivo CSV.</small>
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal para exibir listas de dados -->
<div class="modal fade" id="dataModal" tabindex="-1" aria-labelledby="dataModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="dataModalLabel">Carregando...</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="modalSearchInput" class="form-control mb-3" placeholder="Filtrar resultados...">
        <div id="modalContent" class="list-group" style="max-height: 400px; overflow-y: auto;">
            <div class="text-center p-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Lógica para o modal de detalhes
    const dataModal = document.getElementById('dataModal');
    if (dataModal) {
        let allModalData = [];
        const modalContent = document.getElementById('modalContent');
        const modalTitle = document.getElementById('dataModalLabel');
        const modalSearchInput = document.getElementById('modalSearchInput');

        function renderModalList(data) {
            modalContent.innerHTML = '';
            if (data.length === 0) {
                modalContent.innerHTML = '<div class="list-group-item text-muted">Nenhum item encontrado.</div>';
                return;
            }
            data.forEach(item => {
                const a = document.createElement('a');
                a.href = `/view_user/${item.sam}`;
                a.className = 'list-group-item list-group-item-action flex-column align-items-start';

                const mainInfo = document.createElement('div');
                mainInfo.className = 'd-flex w-100 justify-content-between';

                const name = document.createElement('h6');
                name.className = 'mb-1';
                name.textContent = item.cn || 'Nome não disponível';

                const sam = document.createElement('small');
                sam.className = 'text-muted';
                sam.textContent = item.sam || '';

                mainInfo.appendChild(name);

                // Adiciona a data agendada se existir
                if (item.scheduled_date) {
                    const dateBadge = document.createElement('span');
                    dateBadge.className = 'badge bg-dark';
                    dateBadge.textContent = `Data: ${item.scheduled_date}`;
                    mainInfo.appendChild(dateBadge);
                } else {
                    mainInfo.appendChild(sam);
                }

                const subInfo = document.createElement('p');
                subInfo.className = 'mb-1 text-muted small';

                const details = [item.title, item.department, item.company].filter(Boolean).join(' • ');
                subInfo.textContent = details || 'Sem detalhes adicionais';

                a.appendChild(mainInfo);
                a.appendChild(subInfo);

                // Adiciona o SAM como uma linha separada se a data estiver presente
                if (item.scheduled_date) {
                    const samInfo = document.createElement('small');
                    samInfo.className = 'text-muted';
                    samInfo.textContent = `Login: ${item.sam}`;
                    a.appendChild(samInfo);
                }
                modalContent.appendChild(a);
            });
        }

        modalSearchInput.addEventListener('input', () => {
            const query = modalSearchInput.value.toLowerCase();
            const filteredData = allModalData.filter(item =>
                item.cn.toLowerCase().includes(query) ||
                item.sam.toLowerCase().includes(query)
            );
            renderModalList(filteredData);
        });

        dataModal.addEventListener('show.bs.modal', async function (event) {
            const button = event.relatedTarget;
            const category = button.getAttribute('data-category');
            const title = button.getAttribute('data-title');

            modalTitle.textContent = title;
            modalContent.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
            modalSearchInput.value = '';

            try {
                const response = await fetch(`/api/dashboard_list/${category}`);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Falha ao carregar dados.' }));
                    throw new Error(errorData.error || 'Falha ao carregar dados.');
                }

                // Corrigido: Extrai a lista 'items' da resposta JSON
                const responseData = await response.json();
                allModalData = responseData.items || []; // Garante que é um array
                renderModalList(allModalData);

            } catch (error) {
                modalContent.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            }
        });
    }

    // Lógica para a lista de senhas expirando
    const expiringPasswordsData = {{ expiring_passwords|tojson }};
    const listContainer = document.getElementById('expiring-list-container');
    const paginationControls = document.getElementById('expiring-pagination-controls');
    const searchInput = document.getElementById('expiring-search-input');
    const totalBadge = document.getElementById('expiring-total');

    let currentPage = 1;
    const itemsPerPage = 5;
    let filteredData = [...expiringPasswordsData];

    function renderList() {
        listContainer.innerHTML = '';
        if (filteredData.length === 0) {
            listContainer.innerHTML = '<div class="text-center text-muted p-4">Nenhum usuário encontrado.</div>';
            renderPagination();
            return;
        }

        const pageData = filteredData.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

        pageData.forEach(user => {
            const listItem = document.createElement('div');
            listItem.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center glass-list-item';

            const userInfo = document.createElement('div');
            const userName = document.createElement('strong');
            userName.textContent = user.cn;
            const userSam = document.createElement('small');
            userSam.className = 'ms-2 text-muted';
            userSam.textContent = `(${user.sam})`;
            userInfo.appendChild(userName);
            userInfo.appendChild(userSam);

            const expiryBadge = document.createElement('span');
            expiryBadge.className = 'badge bg-warning text-dark';
            expiryBadge.textContent = `Expira em ${user.expires_in_days} dia(s)`;

            listItem.appendChild(userInfo);
            listItem.appendChild(expiryBadge);
            listContainer.appendChild(listItem);
        });
        renderPagination();
    }

    function renderPagination() {
        paginationControls.innerHTML = '';
        const totalPages = Math.ceil(filteredData.length / itemsPerPage);

        if (totalPages <= 1) return;

        // Botão 'Primeiro'
        const firstBtn = createPaginationButton('«', () => { if (currentPage > 1) { currentPage = 1; renderList(); } }, currentPage === 1);
        paginationControls.appendChild(firstBtn);

        // Botão 'Anterior'
        const prevBtn = createPaginationButton('‹', () => { if (currentPage > 1) { currentPage--; renderList(); } }, currentPage === 1);
        paginationControls.appendChild(prevBtn);

        // Indicador de Página
        const pageIndicator = document.createElement('span');
        pageIndicator.className = 'page-indicator px-2 py-1';
        pageIndicator.textContent = `Pág ${currentPage} de ${totalPages}`;
        paginationControls.appendChild(pageIndicator);

        // Botão 'Próximo'
        const nextBtn = createPaginationButton('›', () => { if (currentPage < totalPages) { currentPage++; renderList(); } }, currentPage === totalPages);
        paginationControls.appendChild(nextBtn);

        // Botão 'Último'
        const lastBtn = createPaginationButton('»', () => { if (currentPage < totalPages) { currentPage = totalPages; renderList(); } }, currentPage === totalPages);
        paginationControls.appendChild(lastBtn);
    }

    function createPaginationButton(text, onClick, disabled = false) {
        const button = document.createElement('button');
        button.className = 'btn btn-sm btn-outline-secondary';
        button.textContent = text;
        button.disabled = disabled;
        button.addEventListener('click', onClick);
        return button;
    }

    searchInput.addEventListener('input', () => {
        const query = searchInput.value.toLowerCase();
        filteredData = expiringPasswordsData.filter(user =>
            user.cn.toLowerCase().includes(query) ||
            user.sam.toLowerCase().includes(query)
        );
        currentPage = 1;
        totalBadge.textContent = `Total: ${filteredData.length}`;
        renderList();
    });

    // Renderização inicial
    renderList();
});
</script>

<style>
    .glass-list-item {
        background-color: rgba(255, 255, 255, 0.05);
        border: none;
        color: var(--text-color);
    }
    .glass-list-item:hover {
        background-color: rgba(255, 255, 255, 0.1);
        color: var(--text-color);
    }
    .page-indicator {
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 0.25rem;
        font-size: 0.875em;
    }
</style>
{% endblock %}