{% extends "base.html" %}

{% block title %}Dashboard Operacional{% endblock %}

{% block page_title %}
<div class="page-header">
    <h1><i class="fas fa-chart-line me-2"></i>Dashboard Operacional</h1>
    <div>
        <a href="{{ url_for('address_book') }}" class="btn btn-info"><i class="fas fa-address-book me-2"></i>Catálogo de Endereços</a>
        <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary">
            <i class="fas fa-sign-out-alt me-2"></i>Sair ({{ session.get('user_display_name', 'Usuário') }})
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Linha dos Cards de Estatísticas -->
<div class="row justify-content-center">
    {% if dashboard_data.user_stats is not none %}
    <div class="col-lg-3 col-md-6 mb-4 dashboard-stat-card" data-bs-toggle="modal" data-bs-target="#dataModal" data-category="active_users" data-title="Contas Ativas">
        <div class="card glass-card h-100">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="text-muted text-uppercase fs-7">Contas Ativas</div>
                    <div class="fs-2 fw-bold text-success">{{ dashboard_data.user_stats.active }}</div>
                </div>
                <div class="fs-2 text-success opacity-75"><i class="fas fa-user-check"></i></div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4 dashboard-stat-card" data-bs-toggle="modal" data-bs-target="#dataModal" data-category="disabled_users" data-title="Contas Desativadas (Total)">
        <div class="card glass-card h-100">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="text-muted text-uppercase fs-7">Contas Desativadas (Total)</div>
                    <div class="fs-2 fw-bold text-warning">{{ dashboard_data.user_stats.disabled }}</div>
                </div>
                <div class="fs-2 text-warning opacity-75"><i class="fas fa-user-slash"></i></div>
            </div>
        </div>
    </div>
    {% endif %}
    {% if dashboard_data.scheduled_deactivations is not none %}
    <div class="col-lg-3 col-md-6 mb-4 dashboard-stat-card" data-bs-toggle="modal" data-bs-target="#dataModal" data-category="scheduled_deactivations" data-title="Desativações Agendadas (Próx. 7 Dias)">
        <div class="card glass-card h-100">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="text-muted text-uppercase fs-7">Desativações (Próx. 7 dias)</div>
                    <div class="fs-2 fw-bold text-primary">{{ dashboard_data.scheduled_deactivations.count }}</div>
                </div>
                <div class="fs-2 text-primary opacity-75"><i class="fas fa-calendar-times"></i></div>
            </div>
        </div>
    </div>
    {% endif %}
    {% if dashboard_data.deactivated_last_7_days is not none %}
    <div class="col-lg-3 col-md-6 mb-4 dashboard-stat-card" data-bs-toggle="modal" data-bs-target="#dataModal" data-category="deactivated_last_7_days" data-title="Desativados (Últimos 7 Dias)">
        <div class="card glass-card h-100">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="text-muted text-uppercase fs-7">Desativados (Últimos 7 Dias)</div>
                    <div class="fs-2 fw-bold text-danger">{{ dashboard_data.deactivated_last_7_days.count }}</div>
                </div>
                <div class="fs-2 text-danger opacity-75"><i class="fas fa-user-clock"></i></div>
            </div>
        </div>
    </div>
    {% endif %}
    {% if dashboard_data.pending_reactivations is not none %}
    <div class="col-lg-3 col-md-6 mb-4 dashboard-stat-card" data-bs-toggle="modal" data-bs-target="#dataModal" data-category="pending_reactivations" data-title="Reativações Agendadas (Próx. 7 Dias)">
        <div class="card glass-card h-100">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="text-muted text-uppercase fs-7">Reativações (Próx. 7 dias)</div>
                    <div class="fs-2 fw-bold text-info">{{ dashboard_data.pending_reactivations.count }}</div>
                </div>
                <div class="fs-2 text-info opacity-75"><i class="fas fa-calendar-check"></i></div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Linha dos Painéis Principais -->
<div class="row">
    <!-- Painel de Senhas Expirando -->
    {% if dashboard_data.expiring_passwords is not none %}
    <div class="col-lg-8 mb-4">
        <div class="card glass-card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-key me-2 text-warning"></i>Senhas Expirando (Próximos 5 dias)</h5>
                <span id="expiring-total" class="badge bg-dark rounded-pill">Total: {{ dashboard_data.expiring_passwords|length }}</span>
            </div>
            <div class="card-body p-0" style="min-height: 250px;">
                <div id="expiring-list-container" class="list-group list-group-flush">
                    <!-- O conteúdo será preenchido por JavaScript -->
                </div>
            </div>
            <div class="card-footer d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div class="flex-grow-1" style="min-width: 200px;">
                    <input type="text" id="expiring-search-input" class="form-control form-control-sm" placeholder="Filtrar por nome ou login...">
                </div>
                <nav id="expiring-pagination-controls" class="d-flex align-items-center gap-1">
                    <!-- Controles de paginação serão gerados por JavaScript -->
                </nav>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Painel de Ações Rápidas -->
    <div class="{% if dashboard_data.expiring_passwords is not none %}col-lg-4{% else %}col-lg-12{% endif %} mb-4">
        <div class="card glass-card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-rocket me-2"></i>Ações Rápidas</h5>
            </div>
            <div class="list-group list-group-flush">
                {% if check_permission(action='can_create') %}
                <a href="{{ url_for('create_user_form') }}" class="list-group-item list-group-item-action glass-list-item">
                    <h6 class="mb-1"><i class="fas fa-user-plus me-2 text-primary"></i>Criar Novo Usuário</h6>
                    <small class="text-muted">Crie um novo usuário no AD usando um modelo.</small>
                </a>
                {% endif %}
                <a href="{{ url_for('manage_users') }}" class="list-group-item list-group-item-action glass-list-item">
                    <h6 class="mb-1"><i class="fas fa-users-cog me-2 text-secondary"></i>Gerenciar Usuários</h6>
                    <small class="text-muted">Busque, edite e gerencie usuários existentes.</small>
                </a>
                {% if check_permission(action='can_manage_groups') %}
                <a href="{{ url_for('group_management') }}" class="list-group-item list-group-item-action glass-list-item">
                    <h6 class="mb-1"><i class="fas fa-layer-group me-2 text-info"></i>Gerenciar Grupos</h6>
                    <small class="text-muted">Adicione ou remova membros de grupos.</small>
                </a>
                {% endif %}
                {% if check_permission(view='can_export_data') %}
                <a href="{{ url_for('export_ad_data') }}" class="list-group-item list-group-item-action glass-list-item">
                    <h6 class="mb-1"><i class="fas fa-file-csv me-2 text-success"></i>Exportar Base AD</h6>
                    <small class="text-muted">Exporte os dados dos usuários para um arquivo CSV.</small>
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal para exibir listas de dados -->
<div class="modal fade" id="dataModal" tabindex="-1" aria-labelledby="dataModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="dataModalLabel">Carregando...</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="modalSearchInput" class="form-control mb-3" placeholder="Filtrar resultados...">
        <div id="modalContent" class="list-group" style="max-height: 400px; overflow-y: auto;">
            <div class="text-center p-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Lógica para o modal de detalhes
    const dataModal = document.getElementById('dataModal');
    if (dataModal) {
        const modalContent = document.getElementById('modalContent');
        const modalTitle = document.getElementById('dataModalLabel');
        const modalSearchInput = document.getElementById('modalSearchInput');
        let currentCategory = '';
        let originalData = [];
        let currentPage = 1;

        function createPaginationControls(totalPages, fetchData) {
            const container = document.createElement('nav');
            container.className = 'd-flex justify-content-center mt-3';
            if (totalPages <= 1) return container;

            const list = document.createElement('ul');
            list.className = 'pagination';

            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            const prevA = document.createElement('a');
            prevA.className = 'page-link';
            prevA.href = '#';
            prevA.textContent = 'Anterior';
            prevA.onclick = (e) => { e.preventDefault(); if (currentPage > 1) fetchData(currentCategory, currentPage - 1); };
            prevLi.appendChild(prevA);
            list.appendChild(prevLi);

            const pageLi = document.createElement('li');
            pageLi.className = 'page-item disabled';
            const pageA = document.createElement('a');
            pageA.className = 'page-link';
            pageA.textContent = `Página ${currentPage} de ${totalPages}`;
            pageLi.appendChild(pageA);
            list.appendChild(pageLi);

            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            const nextA = document.createElement('a');
            nextA.className = 'page-link';
            nextA.href = '#';
            nextA.textContent = 'Próximo';
            nextA.onclick = (e) => { e.preventDefault(); if (currentPage < totalPages) fetchData(currentCategory, currentPage + 1); };
            nextLi.appendChild(nextA);
            list.appendChild(nextLi);

            container.appendChild(list);
            return container;
        }

        function renderModalList(data, totalPages, fetchData) {
            modalContent.innerHTML = '';
            if (!data || data.length === 0) {
                modalContent.innerHTML = '<div class="list-group-item">Nenhum item encontrado.</div>';
                return;
            }
            data.forEach(item => {
                const a = document.createElement('a');
                a.href = `/view_user/${item.sam}`;
                a.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';

                const mainInfo = document.createElement('div');
                mainInfo.innerHTML = `<strong>${item.cn}</strong> (${item.sam})<br><small class="text-muted">${item.title || 'N/A'} - ${item.location || 'N/A'}</small>`;

                a.appendChild(mainInfo);

                if(item.date) {
                    const dateBadge = document.createElement('span');
                    dateBadge.className = 'badge bg-secondary';
                    dateBadge.textContent = item.date;
                    a.appendChild(dateBadge);
                }
                modalContent.appendChild(a);
            });

            const pagination = createPaginationControls(totalPages, fetchData);
            modalContent.appendChild(pagination);
        }

        async function fetchData(category, page = 1) {
            currentCategory = category;
            currentPage = page;
            modalContent.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div></div>';
            try {
                const response = await fetch(`/api/dashboard_list/${category}?page=${page}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Falha ao carregar dados.');
                }
                const data = await response.json();
                originalData = data.items;
                renderModalList(data.items, data.total_pages, fetchData);
            } catch (error) {
                modalContent.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            }
        }

        modalSearchInput.addEventListener('input', () => {
             const query = modalSearchInput.value.toLowerCase();
             if(query === '') {
                 fetchData(currentCategory, 1);
                 return;
             }
             const filteredData = originalData.filter(item =>
                (item.cn && item.cn.toLowerCase().includes(query)) ||
                (item.sam && item.sam.toLowerCase().includes(query))
             );
             renderModalList(filteredData, 1, ()=>{});
        });

        dataModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const category = button.getAttribute('data-category');
            const title = button.getAttribute('data-title');
            modalTitle.textContent = title;
            modalSearchInput.value = '';
            fetchData(category, 1);
        });
    }

    // Lógica para a lista de senhas expirando
    const expiringPasswordsData = {{ dashboard_data.expiring_passwords|tojson|default([]) }};
    if (document.getElementById('expiring-list-container')) {
        const listContainer = document.getElementById('expiring-list-container');
        const paginationControls = document.getElementById('expiring-pagination-controls');
        const searchInput = document.getElementById('expiring-search-input');
        const totalBadge = document.getElementById('expiring-total');
        let currentPage = 1;
        const itemsPerPage = 5;
        let filteredData = [...expiringPasswordsData];

        function renderList() {
            listContainer.innerHTML = '';
            if (filteredData.length === 0) {
                listContainer.innerHTML = '<div class="text-center text-muted p-4">Nenhum usuário encontrado.</div>';
                renderPagination();
                return;
            }
            const pageData = filteredData.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);
            pageData.forEach(user => {
                const listItem = document.createElement('a');
                listItem.href = `/view_user/${user.sam}`;
                listItem.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center glass-list-item';
                const userInfo = document.createElement('div');
                userInfo.innerHTML = `<strong>${user.cn}</strong> <small class="text-muted">(${user.sam})</small>`;
                const expiryBadge = document.createElement('span');
                expiryBadge.className = 'badge bg-warning text-dark';
                expiryBadge.textContent = `Expira em ${user.expires_in_days} dia(s)`;
                listItem.appendChild(userInfo);
                listItem.appendChild(expiryBadge);
                listContainer.appendChild(listItem);
            });
            renderPagination();
        }

        function renderPagination() {
            paginationControls.innerHTML = '';
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (totalPages <= 1) return;
            const firstBtn = createPaginationButton('«', () => { if (currentPage > 1) { currentPage = 1; renderList(); } }, currentPage === 1);
            paginationControls.appendChild(firstBtn);
            const prevBtn = createPaginationButton('‹', () => { if (currentPage > 1) { currentPage--; renderList(); } }, currentPage === 1);
            paginationControls.appendChild(prevBtn);
            const pageIndicator = document.createElement('span');
            pageIndicator.className = 'page-indicator px-2 py-1';
            pageIndicator.textContent = `Pág ${currentPage} de ${totalPages}`;
            paginationControls.appendChild(pageIndicator);
            const nextBtn = createPaginationButton('›', () => { if (currentPage < totalPages) { currentPage++; renderList(); } }, currentPage === totalPages);
            paginationControls.appendChild(nextBtn);
            const lastBtn = createPaginationButton('»', () => { if (currentPage < totalPages) { currentPage = totalPages; renderList(); } }, currentPage === totalPages);
            paginationControls.appendChild(lastBtn);
        }

        function createPaginationButton(text, onClick, disabled = false) {
            const button = document.createElement('button');
            button.className = 'btn btn-sm btn-outline-secondary';
            button.textContent = text;
            button.disabled = disabled;
            button.addEventListener('click', onClick);
            return button;
        }

        searchInput.addEventListener('input', () => {
            const query = searchInput.value.toLowerCase();
            filteredData = expiringPasswordsData.filter(user =>
                user.cn.toLowerCase().includes(query) ||
                user.sam.toLowerCase().includes(query)
            );
            currentPage = 1;
            totalBadge.textContent = `Total: ${filteredData.length}`;
            renderList();
        });

        renderList();
    }
});
</script>

<style>
    .glass-list-item {
        background-color: rgba(255, 255, 255, 0.05);
        border: none;
        color: var(--text-color);
    }
    .glass-list-item:hover {
        background-color: rgba(255, 255, 255, 0.1);
        color: var(--text-color);
    }
    .page-indicator {
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 0.25rem;
        font-size: 0.875em;
    }
</style>
{% endblock %}