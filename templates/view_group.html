{% extends "base.html" %}
{% from "_form_helpers.html" import render_field %}

{% block title %}Gerenciar Grupo: {{ group.cn.value }}{% endblock %}

{% from "_macros.html" import render_page_header %}

{% block page_title %}
    {% set title_html %}
        <i class="fas fa-users-cog me-2"></i>Grupo: {{ group.cn.value }}
        <p class="text-muted mb-0 fs-6 fw-normal">{{ get_attr_value(group, 'description') or 'Sem descrição.' }}</p>
    {% endset %}
    {% set extra_actions_html %}
        <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#addUserModal">
            <i class="fas fa-user-plus me-2"></i>Adicionar Usuário
        </button>
    {% endset %}
    {{ render_page_header(title_html, extra_actions=extra_actions_html) }}
{% endblock %}

{% block content %}
<!-- Card da Lista de Membros -->
<div class="card glass-card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Membros Atuais</h5>
        <div class="col-md-5 col-lg-4">
            <input type="text" id="member-search-input" class="form-control form-control-sm" placeholder="Filtrar membros atuais...">
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive" id="members-table-container">
            <div class="text-center p-5" id="loading-spinner">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">Carregando membros...</p>
            </div>
        </div>
    </div>
    <div class="card-footer text-center">
        <span id="member-count-badge" class="badge bg-secondary rounded-pill fs-6">Carregando...</span>
    </div>
</div>

<!-- ========================================================================== -->
<!-- Modal de Adicionar Usuário                                                 -->
<!-- ========================================================================== -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addUserModalLabel"><i class="fas fa-user-plus me-2"></i>Adicionar Usuário ao Grupo: {{ group.cn.value }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex mb-3">
                    <input type="text" id="user-search-input" class="form-control me-2" placeholder="Digite 3+ caracteres para buscar por nome ou login...">
                    <button id="user-search-button" class="btn btn-primary"><i class="fas fa-search"></i></button>
                </div>
                <div class="table-responsive" id="user-search-results-container" style="min-height: 200px;">
                    <p class="text-muted text-center pt-5">Aguardando busca...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Formulários ocultos para ações que precisam de POST. Eles são acionados via JavaScript. -->
<form id="remove-member-form" method="POST" style="display: none;"></form>
<form id="add-member-form" method="POST" style="display: none;">
    {{ form.csrf_token() }}
    <input type="hidden" name="user_sam" id="user-sam-to-add-hidden">
</form>
<form id="add-member-temp-form" method="POST" style="display: none;">
    {{ form.csrf_token() }}
    <input type="hidden" name="user_sam" id="user-sam-to-add-temp-hidden">
</form>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const groupName = {{ group.cn.value|tojson }};
    let memberListPage = 1;
    let memberListQuery = '';
    let memberDebounceTimer;
    let userSearchDebounceTimer;

    const membersTableContainer = document.getElementById('members-table-container');
    const memberPaginationContainer = document.getElementById('pagination-container'); // This element is not in the updated HTML, but the JS expects it. Let's create it.
    const memberLoadingSpinner = document.getElementById('loading-spinner');
    const memberSearchInput = document.getElementById('member-search-input');
    const memberCountBadge = document.getElementById('member-count-badge');
    const removeMemberForm = document.getElementById('remove-member-form');

    const addUserModal = new bootstrap.Modal(document.getElementById('addUserModal'));
    const userSearchInput = document.getElementById('user-search-input');
    const userSearchButton = document.getElementById('user-search-button');
    const userSearchResultsContainer = document.getElementById('user-search-results-container');
    const addMemberForm = document.getElementById('add-member-form');
    const userSamToAddHidden = document.getElementById('user-sam-to-add-hidden');
    const addMemberTempForm = document.getElementById('add-member-temp-form');
    const userSamToAddTempHidden = document.getElementById('user-sam-to-add-temp-hidden');

    // Create the pagination container dynamically if it's missing, to avoid JS errors
    let paginationDiv = document.getElementById('pagination-container');
    if (!paginationDiv) {
        paginationDiv = document.createElement('div');
        paginationDiv.id = 'pagination-container';
        paginationDiv.className = 'd-flex justify-content-center mt-3';
        const card = document.querySelector('.card.glass-card');
        card.parentNode.insertBefore(paginationDiv, card.nextSibling);
    }

    async function fetchMembers(page = 1, query = '') {
        memberLoadingSpinner.style.display = 'block';
        if(page === 1) membersTableContainer.innerHTML = '';
        membersTableContainer.appendChild(memberLoadingSpinner);

        try {
            const response = await fetch(`/api/group_members/${groupName}?page=${page}&query=${encodeURIComponent(query)}`);
            if (!response.ok) throw new Error(`Erro na rede: ${response.statusText}`);

            const data = await response.json();
            renderMembers(data.members);
            renderPagination(data, paginationDiv, (newPage) => {
                memberListPage = newPage;
                fetchMembers(memberListPage, memberListQuery);
            });
            memberCountBadge.textContent = `${data.total} Membro(s)`;
        } catch (error) {
            console.error('Erro ao buscar membros:', error);
            membersTableContainer.innerHTML = `<div class="alert alert-danger m-3">Falha ao carregar membros.</div>`;
            memberCountBadge.textContent = 'Erro';
        } finally {
            if (memberLoadingSpinner.parentNode) {
                memberLoadingSpinner.style.display = 'none';
            }
        }
    }

    function renderMembers(members) {
        membersTableContainer.innerHTML = '';
        if (!members || members.length === 0) {
            membersTableContainer.innerHTML = `<div class="alert alert-info m-3">Nenhum membro encontrado para os critérios atuais.</div>`;
            return;
        }

        const table = createTable(['Nome', 'Login', 'Cargo', 'Cidade', 'Ação']);
        const tbody = table.querySelector('tbody');
        members.forEach(member => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${member.displayName}</td>
                <td>${member.sAMAccountName}</td>
                <td>${member.title || 'N/A'}</td>
                <td>${member.city || 'N/A'}</td>
                <td class="text-end">
                    <button class="btn btn-sm btn-danger remove-btn" data-user-sam="${member.sAMAccountName}" title="Remover permanentemente">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
        });

        membersTableContainer.appendChild(table);

        document.querySelectorAll('.remove-btn').forEach(button => {
            button.addEventListener('click', function() {
                if (confirm(`Tem certeza que deseja remover o usuário '${this.dataset.userSam}' do grupo?`)) {
                    removeMemberForm.action = `/remove_member/${groupName}/${this.dataset.userSam}`;
                    removeMemberForm.submit();
                }
            });
        });
    }

    async function searchUsers(query) {
        userSearchResultsContainer.innerHTML = '<div class="text-center p-4"><div class="spinner-border spinner-border-sm" role="status"></div> Buscando...</div>';
        try {
            const response = await fetch(`/api/search_users_for_group/${groupName}?query=${encodeURIComponent(query)}`);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Erro na busca');
            }
            const users = await response.json();
            renderUserSearchResults(users);
        } catch (error) {
            userSearchResultsContainer.innerHTML = `<div class="alert alert-warning">${error.message}</div>`;
        }
    }

    function renderUserSearchResults(users) {
        userSearchResultsContainer.innerHTML = '';
        if (!users || users.length === 0) {
            userSearchResultsContainer.innerHTML = `<div class="alert alert-info m-0">Nenhum usuário encontrado que já não seja membro.</div>`;
            return;
        }

        const table = createTable(['Nome', 'Login', 'Cargo', 'Cidade', 'Ações']);
        const tbody = table.querySelector('tbody');
        users.forEach(user => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${user.displayName}</td>
                <td>${user.sAMAccountName}</td>
                <td>${user.title || 'N/A'}</td>
                <td>${user.city || 'N/A'}</td>
                <td class="text-center">
                    <div class="btn-group">
                        <button class="btn btn-sm btn-success add-permanent-btn" data-user-sam="${user.sAMAccountName}"><i class="fas fa-plus"></i> Add</button>
                        <button class="btn btn-sm btn-info add-temp-btn" data-user-sam="${user.sAMAccountName}"><i class="fas fa-clock"></i> Temp</button>
                    </div>
                </td>
            `;
        });

        userSearchResultsContainer.appendChild(table);

        document.querySelectorAll('.add-permanent-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const userSam = this.dataset.userSam;
                if(confirm(`Adicionar '${userSam}' permanentemente ao grupo?`)) {
                    userSamToAddHidden.value = userSam;
                    addMemberForm.action = `/add_member/${groupName}`;
                    addMemberForm.submit();
                }
            });
        });

        document.querySelectorAll('.add-temp-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const userSam = this.dataset.userSam;
                const days = prompt(`Adicionar o usuário '${userSam}' ao grupo por quantos dias?`, '30');
                if (days && !isNaN(days) && parseInt(days) > 0) {
                    userSamToAddTempHidden.value = userSam;
                    addMemberTempForm.action = `/add_member_temp/${groupName}?days=${parseInt(days)}`;
                    addMemberTempForm.submit();
                } else if(days !== null) {
                    alert("Por favor, insira um número de dias válido.");
                }
            });
        });
    }

    function createTable(headers) {
        const table = document.createElement('table');
        table.className = 'table table-sm table-hover glass-table mb-0';
        const thead = table.createTHead();
        const tbody = table.createTBody();
        const headerRow = thead.insertRow();
        headers.forEach(headerText => {
            const th = document.createElement('th');
            th.textContent = headerText;
            headerRow.appendChild(th);
        });
        return table;
    }

    function renderPagination(data, container, callback) {
        container.innerHTML = '';
        if (data.total_pages <= 1) return;

        const nav = document.createElement('nav');
        const ul = document.createElement('ul');
        ul.className = 'pagination pagination-sm justify-content-center';

        const prevDisabled = data.page === 1 ? 'disabled' : '';
        const nextDisabled = data.page === data.total_pages ? 'disabled' : '';
        ul.innerHTML += `<li class="page-item ${prevDisabled}"><a class="page-link" href="#" data-page="${data.page - 1}">Anterior</a></li>`;
        ul.innerHTML += `<li class="page-item disabled"><span class="page-link">Página ${data.page} de ${data.total_pages}</span></li>`;
        ul.innerHTML += `<li class="page-item ${nextDisabled}"><a class="page-link" href="#" data-page="${data.page + 1}">Próximo</a></li>`;

        nav.appendChild(ul);
        container.appendChild(nav);

        container.querySelectorAll('a.page-link').forEach(link => {
            if(!link.parentElement.classList.contains('disabled')) {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    callback(parseInt(link.dataset.page));
                });
            }
        });
    }

    memberSearchInput.addEventListener('keyup', function(event) {
        clearTimeout(memberDebounceTimer);
        memberDebounceTimer = setTimeout(() => {
            memberListPage = 1;
            memberListQuery = event.target.value;
            fetchMembers(memberListPage, memberListQuery);
        }, 300);
    });

    const triggerUserSearch = () => {
        const query = userSearchInput.value;
        if (query.length >= 3) {
            searchUsers(query);
        } else {
            userSearchResultsContainer.innerHTML = '<p class="text-muted text-center pt-5">Digite pelo menos 3 caracteres para iniciar a busca.</p>';
        }
    };

    userSearchButton.addEventListener('click', triggerUserSearch);
    userSearchInput.addEventListener('keyup', (e) => {
        if (e.key === 'Enter') {
            triggerUserSearch();
        } else {
            clearTimeout(userSearchDebounceTimer);
            userSearchDebounceTimer = setTimeout(triggerUserSearch, 400);
        }
    });

    fetchMembers(memberListPage, memberListQuery);
});
</script>
{% endblock %}