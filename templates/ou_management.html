{% extends "base.html" %}

{% block title %}Gerenciamento de OUs{% endblock %}

{% from "_macros.html" import render_page_header %}

{% block head %}
    {{ super() }}
    <!-- jsTree CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" />
    <style>
        .tree-container {
            height: 70vh;
            overflow: auto;
            border: 1px solid var(--glass-border-color);
            border-radius: .375rem;
            padding: 1rem;
            background-color: var(--glass-bg-color);
        }
        #user-list .list-group-item {
            cursor: grab;
            background-color: var(--glass-bg-color);
            border-color: var(--glass-border-color);
            color: var(--text-color);
        }
        #user-list .list-group-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .jstree-node {
            color: var(--text-color) !important;
        }
        .jstree-wholerow-hovered {
            background: rgba(0, 123, 255, 0.2) !important;
        }
        .jstree-wholerow-clicked {
            background: rgba(0, 123, 255, 0.4) !important;
        }
        .vakata-context {
            background-color: var(--background-color);
            border-color: var(--glass-border-color);
        }
        .vakata-context-hover > a {
            background-color: rgba(0, 123, 255, 0.2) !important;
        }
    </style>
{% endblock %}

{% block page_title %}
    {{ render_page_header('<i class="fas fa-network-wired me-2"></i>Gerenciamento de Unidades Organizacionais') }}
{% endblock %}

{% block content %}
<div class="row">
    <!-- Coluna da Árvore de OUs e Busca -->
    <div class="col-md-5">
        <div class="card glass-card mb-4">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-search me-2"></i>Buscar Usuário</h5>
                <form id="search-user-form" class="d-flex">
                    <input type="text" id="user-search-input" class="form-control me-2" placeholder="Digite nome ou login...">
                    <button type="submit" class="btn btn-primary">Buscar</button>
                </form>
                <div id="search-result" class="mt-3"></div>
            </div>
        </div>
        <div class="card glass-card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-sitemap me-2"></i>Estrutura do Active Directory</h5>
            </div>
            <div class="card-body">
                <div id="ou-tree" class="tree-container">
                    <div class="text-center p-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando árvore...</span>
                        </div>
                        <p class="mt-2">Carregando árvore...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Coluna da Lista de Usuários -->
    <div class="col-md-7">
        <div class="card glass-card">
            <div class="card-header">
                <h5 class="mb-0" id="user-list-title"><i class="fas fa-users me-2"></i>Usuários na OU</h5>
            </div>
            <div class="card-body">
                 <div id="user-list-container" class="tree-container">
                    <div id="user-list-placeholder" class="text-center text-muted p-5">
                        <i class="fas fa-arrow-left fa-3x mb-3"></i>
                        <h5>Selecione uma OU na árvore para ver os usuários.</h5>
                    </div>
                    <div id="user-list" class="list-group" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- jQuery (dependência do jsTree) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<!-- jsTree -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>

<script>
$(function () {
    const csrfToken = "{{ form.csrf_token._value() }}";

    // Função para mostrar alertas
    function showAlert(message, category = 'info') {
        // Reutiliza o sistema de flash messages do base.html se possível, ou cria um novo
        const alertHtml = `
            <div class="alert alert-${category} alert-dismissible fade show" role="alert">
                <i class="fas fa-info-circle me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>`;
        // Insere o alerta após o cabeçalho da página
        $('.page-header').after(alertHtml);
    }

    // Configuração do jsTree
    $('#ou-tree').jstree({
        'core': {
            'data': {
                'url': "{{ url_for('api_ou_tree') }}",
                'dataType': 'json',
                'error': function(xhr) {
                    $('#ou-tree').html('<div class="alert alert-danger">Erro ao carregar a árvore de OUs. Verifique as permissões e a configuração.</div>');
                }
            },
            'themes': {
                'name': 'default',
                'responsive': true,
                'stripes': true
            },
            'check_callback': function (operation, node, node_parent, node_position, more) {
                if (operation === "move_node") {
                    // Permite o drop se o elemento arrastado for de fora da árvore (is_foreign)
                    return more.dnd ? more.is_foreign : false;
                }
                // Permite outras operações (como criar, renomear, etc.)
                return true;
            }
        },
        'dnd': {
            'open_timeout': 500, // Expande a OU após 500ms de hover
            'is_draggable': false // Desativa o DND para os nós da árvore
        },
        'plugins': ['dnd', 'wholerow']
    });

    // Evento: nó da árvore selecionado
    $('#ou-tree').on('select_node.jstree', function (e, data) {
        const ou_dn = data.node.id;
        const ou_name = data.node.text;

        $('#user-list-title').html(`<i class="fas fa-users me-2"></i>Usuários em <strong>${ou_name}</strong>`);
        $('#user-list-placeholder').hide();
        $('#user-list').html('<div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div></div>').show();

        fetch(`{{ url_for('ou_users', ou_dn='__DN__') }}`.replace('__DN__', ou_dn))
            .then(response => response.json())
            .then(users => {
                $('#user-list').empty();
                if (users.length === 0) {
                    $('#user-list').append('<div class="list-group-item text-muted">Nenhum usuário encontrado nesta OU.</div>');
                } else {
                    users.forEach(user => {
                        // Adiciona o prefixo 'user-drag-' para identificar os elementos arrastáveis
                        const userEl = $(`
                            <div class="list-group-item" id="user-drag-${user.id}" draggable="true" data-sam="${user.id}">
                                <i class="fas fa-user me-2"></i>
                                <strong>${user.text}</strong>
                                <small class="text-muted d-block">${user.title || 'Cargo não definido'}</small>
                            </div>
                        `);
                        $('#user-list').append(userEl);
                    });
                }
            })
            .catch(error => {
                $('#user-list').html('<div class="alert alert-danger">Erro ao carregar usuários.</div>');
                console.error('Error fetching users:', error);
            });
    });

    // --- Lógica de Arrastar e Soltar (Drag and Drop) ---

    // 1. Iniciar o arraste a partir da lista de usuários
    // Usamos delegação de eventos para ouvir o 'mousedown' em qualquer item da lista.
    $('#user-list-container').on('mousedown', '.list-group-item', function (e) {
        // Previne o comportamento padrão que poderia interferir no arraste.
        e.preventDefault();
        // Inicia o processo de 'dnd' da jsTree manualmente.
        // Isso "apresenta" o nosso elemento de lista de usuários para a árvore.
        return $.vakata.dnd.start(e, {
            'jstree': true,
            'obj': $(this),
            'nodes': [{ id: $(this).data('sam'), text: $(this).find('strong').text() }]
        });
    });

    // 2. Lidar com os eventos de movimento e soltura
    $(document)
        .on('dnd_move.vakata', function (e, data) {
            // A expansão da OU ao passar o mouse é gerenciada automaticamente pelo plugin dnd.
            // O 'check_callback' que definimos garante que o ícone de 'drop' só apareça
            // quando estivermos sobre um nó válido da árvore.
        })
        .on('dnd_stop.vakata', function (e, data) {
            // Evento acionado quando o usuário solta o item.
            const tree = $('#ou-tree').jstree(true);
            const targetNode = tree.get_node(data.reference); // Onde o item foi solto

            // Garante que o drop foi em um nó válido da árvore
            if (!targetNode || targetNode.id === '#') {
                return;
            }

        // Garante que o elemento arrastado é um usuário da lista
        const draggedElement = $(data.element);
        if (!draggedElement.attr('id') || !draggedElement.attr('id').startsWith('user-drag-')) {
            return;
        }

        const user_sam = draggedElement.data('sam');
        const user_text = draggedElement.find('strong').text();
        const target_ou_dn = targetNode.id;

        if (!user_sam || !target_ou_dn) {
            showAlert('Não foi possível identificar o usuário ou a OU de destino.', 'danger');
            return;
        }

        if (!confirm(`Tem certeza que deseja mover o usuário '${user_text}' para a OU '${targetNode.text}'?`)) {
            return;
        }

        fetch("{{ url_for('move_user') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                user_sam: user_sam,
                target_ou_dn: target_ou_dn
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showAlert(result.message, 'success');
                // Remove o usuário da lista para indicar que a ação foi bem-sucedida
                draggedElement.fadeOut(500, function() { $(this).remove(); });
            } else {
                showAlert(result.error || 'Ocorreu um erro desconhecido.', 'danger');
            }
        })
        .catch(error => {
            showAlert('Erro de comunicação ao tentar mover o usuário.', 'danger');
            console.error('Move user error:', error);
        });
    });

    // Busca de usuário
    $('#search-user-form').on('submit', function(e) {
        e.preventDefault();
        const query = $('#user-search-input').val();
        if (query.length < 3) {
            showAlert('Digite pelo menos 3 caracteres para buscar.', 'warning');
            return;
        }

        const searchResultDiv = $('#search-result');
        searchResultDiv.html('<div class="spinner-border spinner-border-sm" role="status"></div> Buscando...');

        fetch("{{ url_for('search_user_location') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify({ query: query })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.error) });
            }
            return response.json();
        })
        .then(data => {
            const tree = $('#ou-tree').jstree(true);
            tree.deselect_all();

            // Abre a árvore até a OU do usuário e a seleciona
            const ouPath = data.ou_dn.split(',').reverse();
            let currentPath = [];
            let fullDnParts = [];

            // Recria os DNs pais para abrir a árvore corretamente
            let parentDns = [];
            const dnParts = data.ou_dn.split(',');
            for (let i = 0; i < dnParts.length -1; i++) {
                parentDns.push(dnParts.slice(i).join(','));
            }
            parentDns.reverse();

            // Abre cada nó pai sequencialmente
            parentDns.forEach(dn => {
                tree.open_node(dn);
            });

            // Seleciona a OU final após um pequeno atraso para garantir que foi aberta
            setTimeout(() => {
                tree.select_node(data.ou_dn);
                const nodeElement = tree.get_node(data.ou_dn, true);
                if (nodeElement) {
                    nodeElement.get(0).scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 500);

            searchResultDiv.html(`
                <div class="alert alert-success">
                    Usuário encontrado! Navegando para: <br>
                    <strong>${data.ou_path.replace(/ --- /g, ' / ')}</strong>
                </div>`);
        })
        .catch(error => {
            searchResultDiv.html(`<div class="alert alert-danger">${error.message}</div>`);
        });
    });
});
</script>
{% endblock %}